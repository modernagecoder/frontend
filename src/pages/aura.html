<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aura Type - Master Your Typing Flow | Modern Age Coders</title>
    <meta name="description" content="Aura Type - A minimalistic, aesthetic typing experience to improve your flow, precision and WPM. Practice with psychological words and motivational phrases.">
    
    <!-- SEO Meta Tags -->
    <meta name="keywords" content="typing practice, typing test, WPM test, typing game, improve typing speed, typing trainer, aura type, modern age coders">
    <meta name="author" content="Modern Age Coders">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://learn.modernagecoders.com/aura">
    <link rel="alternate" hreflang="en-in" href="https://learn.modernagecoders.com/aura" />
    
    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://learn.modernagecoders.com/aura">
    <meta property="og:title" content="Aura Type - Master Your Typing Flow">
    <meta property="og:description" content="A minimalistic, aesthetic typing experience to improve your flow, precision and WPM.">
    <meta property="og:site_name" content="Modern Age Coders">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Aura Type - Master Your Typing Flow">
    <meta name="twitter:description" content="A minimalistic, aesthetic typing experience to improve your flow, precision and WPM.">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&family=Space+Mono:wght@400;700&display=swap"
        rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg-color: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent-primary: #818cf8;
            --accent-secondary: #c084fc;
            --accent-success: #4ade80;
            --accent-error: #f87171;
            --accent-gold: #ffd700;
            --accent-silver: #c0c0c0;
            --accent-bronze: #cd7f32;
            --font-ui: 'Outfit', sans-serif;
            --font-mono: 'Space Mono', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-ui);
            overflow-x: hidden;
            overflow-y: auto;
            min-height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Lock scroll during gameplay */
        body.game-active {
            overflow: hidden !important;
            position: fixed;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        /* Custom scrollbar for body */
        body::-webkit-scrollbar {
            width: 8px;
        }

        body::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        body::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        body::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        /* Minimalist Navigation */
        .mini-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s ease, opacity 0.3s ease;
            pointer-events: none;
        }

        .mini-nav.hidden {
            transform: translateY(-100%);
            opacity: 0;
        }

        .mini-nav a {
            pointer-events: auto;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid transparent;
        }

        .mini-nav a:hover {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--glass-border);
        }

        .mini-nav .logo {
            font-weight: 600;
            color: var(--text-main);
            font-size: 1rem;
            background: none;
            padding: 0.5rem 0;
        }

        .mini-nav .logo:hover {
            color: var(--accent-primary);
            background: none;
        }

        @media (max-width: 480px) {
            .mini-nav {
                padding: 0.75rem 1rem;
            }
            .mini-nav a {
                font-size: 0.85rem;
                padding: 0.4rem 0.8rem;
            }
        }

        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.6;
        }

        .app-container {
            position: relative;
            z-index: 10;
            width: 100%;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
            padding: 2rem 0;
        }

        .screen {
            position: relative;
            width: 90%;
            max-width: 900px;
            height: auto;
            display: none;
            flex-direction: column;
            align-items: center;
            opacity: 0;
        }

        .screen.active {
            display: flex;
            opacity: 1;
        }

        /* Game screen needs to be fixed for smooth gameplay */
        #game-screen {
            position: fixed;
            top: 5%;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem;
            width: 95%;
            max-width: 900px;
            touch-action: none;
            -webkit-overflow-scrolling: none;
            overscroll-behavior: none;
        }

        /* Mobile: position game at top so keyboard doesn't hide content */
        @media (max-width: 768px) {
            #game-screen {
                top: 0;
                padding-top: 1rem;
                height: auto;
                max-height: 55vh;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
            }

            #game-screen .hud-top {
                margin-bottom: 1rem;
            }

            #game-screen .word-display-area {
                margin-bottom: 1rem;
                height: auto;
                min-height: 60px;
            }

            #game-screen .progress-container {
                margin-top: 1rem;
            }
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            border-radius: 24px;
            padding: 3rem;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        h1, h2, h3 {
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #fff 0%, #cbd5e1 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        h1 { font-size: 4rem; margin-bottom: 0.5rem; }
        h2 { font-size: 2.5rem; margin-bottom: 1rem; }
        h3 { font-size: 1.5rem; margin-bottom: 1rem; color: var(--text-muted); -webkit-text-fill-color: initial; font-weight: 500; }

        .subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
            margin-bottom: 2.5rem;
            font-weight: 300;
        }

        .btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-main);
            padding: 1rem 2.5rem;
            font-family: var(--font-ui);
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 50px;
            transition: all 0.3s ease;
            margin-top: 1.5rem;
            backdrop-filter: blur(5px);
        }

        .btn:hover:not(:disabled) {
            background: var(--text-main);
            color: var(--bg-color);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-leaderboard {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            padding: 0.8rem 1.8rem;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0;
        }

        .btn-leaderboard:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary));
            color: white;
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 30px rgba(129, 140, 248, 0.4);
        }

        .level-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
            width: 100%;
        }

        .level-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }

        .level-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent-primary);
        }

        .level-card h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--accent-primary);
            -webkit-text-fill-color: initial;
        }

        .level-card p {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .hud-top {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 800px;
            margin-bottom: 4rem;
            font-family: var(--font-mono);
            color: var(--text-muted);
        }

        .hud-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .hud-stat span {
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .hud-stat strong {
            font-size: 1.5rem;
            color: var(--text-main);
        }

        .word-display-area {
            text-align: center;
            margin-bottom: 3rem;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #target-word {
            font-family: var(--font-ui);
            font-size: 5rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.1);
            letter-spacing: -0.02em;
            position: relative;
        }

        #target-word span { transition: color 0.1s; }
        .char-correct { color: var(--text-main); }
        .char-wrong { color: var(--accent-error); text-decoration: underline; text-decoration-color: var(--accent-error); }
        .char-pending { color: rgba(255, 255, 255, 0.2); }

        #input-field { position: absolute; opacity: 0; top: -1000px; }

        .progress-container {
            width: 100%;
            max-width: 600px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 4rem;
            overflow: hidden;
        }

        #progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            width: 0%;
            transition: width 0.3s ease-out;
            border-radius: 2px;
        }

        /* Leaderboard Modal */
        .leaderboard-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .leaderboard-modal.active {
            display: flex;
            opacity: 1;
        }

        .leaderboard-content {
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 2.5rem;
            position: relative;
            overflow: hidden;
        }

        .leaderboard-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, var(--accent-primary) 0%, transparent 70%);
            opacity: 0.15;
            pointer-events: none;
        }

        .lb-close-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-muted);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .lb-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            color: var(--text-main);
            transform: rotate(90deg) scale(1.1);
        }

        .lb-header {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
        }

        .lb-header h2 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-primary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .lb-header p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .lb-trophy {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .lb-list {
            max-height: 50vh;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .lb-list::-webkit-scrollbar {
            width: 6px;
        }

        .lb-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .lb-list::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 3px;
        }

        .lb-entry {
            display: flex;
            align-items: center;
            padding: 1rem 1.2rem;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .lb-entry:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .lb-entry.top-1 {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 215, 0, 0.05) 100%);
            border-color: rgba(255, 215, 0, 0.3);
        }

        .lb-entry.top-2 {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.12) 0%, rgba(192, 192, 192, 0.04) 100%);
            border-color: rgba(192, 192, 192, 0.25);
        }

        .lb-entry.top-3 {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.12) 0%, rgba(205, 127, 50, 0.04) 100%);
            border-color: rgba(205, 127, 50, 0.25);
        }

        .lb-rank {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 1rem;
            border-radius: 50%;
            margin-right: 1rem;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
        }

        .lb-entry.top-1 .lb-rank {
            background: linear-gradient(135deg, var(--accent-gold), #ffaa00);
            color: #1a1a2e;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .lb-entry.top-2 .lb-rank {
            background: linear-gradient(135deg, var(--accent-silver), #e8e8e8);
            color: #1a1a2e;
            box-shadow: 0 4px 15px rgba(192, 192, 192, 0.3);
        }

        .lb-entry.top-3 .lb-rank {
            background: linear-gradient(135deg, var(--accent-bronze), #e8a060);
            color: #1a1a2e;
            box-shadow: 0 4px 15px rgba(205, 127, 50, 0.3);
        }

        .lb-player-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .lb-player-name {
            font-weight: 600;
            font-size: 1.05rem;
            color: var(--text-main);
            margin-bottom: 0.3rem;
        }

        .lb-player-stats {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.4rem;
        }

        .lb-accuracy-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0.7rem;
            background: rgba(129, 140, 248, 0.15);
            border: 1px solid rgba(129, 140, 248, 0.3);
            border-radius: 20px;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-primary);
            transition: all 0.3s ease;
        }

        .lb-accuracy-icon {
            font-size: 0.9rem;
        }

        .lb-accuracy-value {
            font-weight: 700;
        }

        .lb-entry:hover .lb-accuracy-badge {
            background: rgba(129, 140, 248, 0.25);
            border-color: rgba(129, 140, 248, 0.5);
            transform: scale(1.05);
        }

        .lb-entry.top-1 .lb-accuracy-badge {
            background: rgba(255, 215, 0, 0.15);
            border-color: rgba(255, 215, 0, 0.4);
            color: var(--accent-gold);
        }

        .lb-entry.top-2 .lb-accuracy-badge {
            background: rgba(192, 192, 192, 0.15);
            border-color: rgba(192, 192, 192, 0.4);
            color: var(--accent-silver);
        }

        .lb-entry.top-3 .lb-accuracy-badge {
            background: rgba(205, 127, 50, 0.15);
            border-color: rgba(205, 127, 50, 0.4);
            color: var(--accent-bronze);
        }

        .lb-wpm-display {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
            min-width: 100px;
        }

        .lb-wpm-number {
            font-family: var(--font-mono);
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(129, 140, 248, 0.3);
        }

        .lb-wpm-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 0.2rem;
            font-weight: 500;
        }

        .lb-entry.top-1 .lb-wpm-number {
            background: linear-gradient(135deg, var(--accent-gold), #ffaa00);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));
        }

        .lb-entry.top-2 .lb-wpm-number {
            background: linear-gradient(135deg, var(--accent-silver), #e8e8e8);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(192, 192, 192, 0.4));
        }

        .lb-entry.top-3 .lb-wpm-number {
            background: linear-gradient(135deg, var(--accent-bronze), #e8a060);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(205, 127, 50, 0.4));
        }



        .lb-empty {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .lb-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Badge Styles */
        .badge-container {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.2);
            transition: all 0.4s ease;
            position: relative;
        }

        .badge.unlocked {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            box-shadow: 0 5px 15px rgba(129, 140, 248, 0.3);
            transform: scale(1.1);
        }

        .badge:hover .badge-tooltip {
            opacity: 1;
            transform: translateY(0);
        }

        .badge-tooltip {
            position: absolute;
            bottom: -50px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0;
            transform: translateY(-5px);
            transition: all 0.2s;
            pointer-events: none;
            text-align: center;
            line-height: 1.4;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #toast {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(255, 255, 255, 0.9);
            color: var(--bg-color);
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 500;
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 2000;
        }

        #toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Rules Modal */
        .rules-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.4s ease;
            overflow-y: auto;
            padding: 2rem 1rem;
        }

        .rules-modal.active {
            display: flex;
            opacity: 1;
        }

        .rules-content {
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 2rem;
            position: relative;
            overflow-y: auto;
        }

        .rules-content::-webkit-scrollbar {
            width: 6px;
        }

        .rules-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .rules-content::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 3px;
        }

        .rules-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .rules-header h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #4ade80, var(--accent-primary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .rules-section {
            margin-bottom: 1.5rem;
        }

        .rules-section h3 {
            font-size: 1.1rem;
            color: var(--accent-primary);
            -webkit-text-fill-color: initial;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rules-section p, .rules-section li {
            color: var(--text-muted);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .rules-section ul {
            list-style: none;
            padding-left: 0;
        }

        .rules-section li {
            padding-left: 1.5rem;
            position: relative;
        }

        .rules-section li::before {
            content: '‚Üí';
            position: absolute;
            left: 0;
            color: var(--accent-primary);
        }

        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
        }

        .score-table th, .score-table td {
            padding: 0.6rem 0.8rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
        }

        .score-table th {
            color: var(--accent-primary);
            font-weight: 600;
        }

        .score-table td {
            color: var(--text-muted);
        }

        .score-highlight {
            background: rgba(129, 140, 248, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            color: var(--accent-primary);
            font-family: var(--font-mono);
            font-size: 0.8rem;
        }

        .badge-explain {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
        }

        .badge-explain .badge-icon {
            font-size: 1.5rem;
        }

        .badge-explain .badge-info {
            flex: 1;
        }

        .badge-explain .badge-name {
            color: var(--text-main);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .badge-explain .badge-req {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        @media (max-width: 1024px) {
            h1 { font-size: 3rem; }
            #target-word { font-size: 4rem; }
            .glass-panel { padding: 2rem; width: 85%; }
        }

        @media (max-width: 768px) {
            h1 { font-size: 2.5rem; }
            .subtitle { font-size: 1rem; margin-bottom: 2rem; }
            .level-info { grid-template-columns: 1fr; gap: 0.8rem; }
            .glass-panel { padding: 1.5rem; width: 95%; border-radius: 16px; }
            .hud-top { margin-bottom: 0.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
            .hud-stat { flex-direction: row; justify-content: space-between; background: rgba(255, 255, 255, 0.03); padding: 0.4rem 0.8rem; border-radius: 8px; width: 100%; }
            .hud-stat span { margin-bottom: 0; margin-right: 0.5rem; font-size: 0.65rem; }
            .hud-stat strong { font-size: 1rem; }
            #target-word { font-size: 2.5rem; height: auto; min-height: 50px; line-height: 1.2; }
            .word-display-area { height: auto; min-height: 60px; margin-bottom: 0.5rem; }
            .progress-container { margin-top: 0.5rem; }
            .btn { padding: 0.8rem 2rem; font-size: 1rem; width: 100%; max-width: 300px; }
            input[type="text"] { font-size: 16px; }
            .leaderboard-content { padding: 1.5rem; }
            .lb-header h2 { font-size: 1.5rem; }
            .lb-entry { padding: 0.8rem; }
            .lb-rank { width: 35px; height: 35px; font-size: 0.85rem; }
            .lb-player-stats { flex-direction: row; gap: 0.3rem; margin-top: 0.3rem; }
            .lb-wpm-number { font-size: 2rem; }
            .lb-wpm-display { min-width: 80px; }
            .lb-accuracy-badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
        }

        @media (max-width: 480px) {
            h1 { font-size: 2rem; }
            #target-word { font-size: 2rem; word-break: break-all; min-height: 40px; }
            .badge-container { gap: 0.8rem; }
            .badge { width: 40px; height: 40px; font-size: 1rem; }
            .btn { padding: 1rem; }
            .app-container { padding: 4rem 0 2rem; }
            .glass-panel { margin: 1rem; }
            .type-hint { display: none; }
            .word-display-area { min-height: 50px; margin-bottom: 0; }
            .hud-stat span { font-size: 0.6rem; }
            .hud-stat strong { font-size: 0.9rem; }
        }

        /* Mobile scroll indicator */
        @media (max-width: 768px) {
            .screen.glass-panel {
                max-height: none;
                overflow-y: visible;
            }
            
            .rules-modal, .leaderboard-modal {
                align-items: flex-start;
                padding-top: 1rem;
            }
            
            .rules-content, .leaderboard-content {
                margin: 1rem;
                max-height: none;
            }
        }

        button { touch-action: manipulation; }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>
    <!-- Minimalist Navigation -->
    <nav class="mini-nav" id="mini-nav">
        <a href="/courses" class="logo">Modern Age Coders</a>
        <a href="/courses">Courses</a>
    </nav>

    <canvas id="bg-canvas"></canvas>

    <div class="app-container">
        <!-- START SCREEN -->
        <div id="start-screen" class="screen active glass-panel" style="text-align: center;">
            <h1>Aura Type</h1>
            <p class="subtitle">Find your flow. Master your precision.</p>

            <div class="level-info">
                <div class="level-card">
                    <h3>Flow</h3>
                    <p>Short words. Pure rhythm.</p>
                </div>
                <div class="level-card">
                    <h3>Precision</h3>
                    <p>Complex terms. Steady focus.</p>
                </div>
                <div class="level-card">
                    <h3>Mastery</h3>
                    <p>Phrases. The ultimate test.</p>
                </div>
            </div>

            <div style="margin-bottom: 2rem; color: var(--text-muted); font-size: 0.9rem;">
                <p>Press <span style="border: 1px solid rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px;">Space</span> to Start</p>
            </div>

            <button id="btn-start" class="btn">Begin Journey</button>

            <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; margin-top: 1.5rem;">
                <button id="btn-view-leaderboard" class="btn btn-leaderboard">
                    <span>üèÜ</span> Leaderboard
                </button>
                <button id="btn-how-to-play" class="btn btn-leaderboard" style="background: linear-gradient(135deg, #4ade80, #22c55e);">
                    <span>üìñ</span> How to Play
                </button>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="screen">
            <div class="hud-top">
                <div class="hud-stat"><span>Stage</span><strong id="hud-round">Flow</strong></div>
                <div class="hud-stat"><span>Score</span><strong id="hud-score">0</strong></div>
                <div class="hud-stat"><span>Time</span><strong id="hud-time">60</strong></div>
                <div class="hud-stat"><span>WPM</span><strong id="hud-wpm">0</strong></div>
            </div>

            <div class="word-display-area">
                <div id="target-word">Loading...</div>
            </div>

            <input type="text" id="input-field" autocomplete="off" spellcheck="false">

            <div class="type-hint" style="color: var(--text-muted); font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.6;">
                Type the word above
            </div>

            <div class="progress-container">
                <div id="progress-fill"></div>
            </div>
        </div>

        <!-- ROUND END SCREEN -->
        <div id="round-screen" class="screen glass-panel" style="text-align: center;">
            <h2 style="color: var(--accent-success); -webkit-text-fill-color: initial;">Stage Complete</h2>
            <p class="subtitle" id="round-name-display">Flow Stage Cleared</p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; margin: 2rem 0;">
                <div>
                    <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">ACCURACY</div>
                    <div id="round-acc" style="font-size: 2.5rem; font-weight: 700;">98%</div>
                </div>
                <div>
                    <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">WORDS</div>
                    <div id="round-words" style="font-size: 2.5rem; font-weight: 700;">15</div>
                </div>
            </div>
            <button id="btn-next-round" class="btn">Continue</button>
        </div>

        <!-- FINAL SCREEN -->
        <div id="end-screen" class="screen glass-panel" style="text-align: center;">
            <h1>Journey Complete</h1>
            <p class="subtitle">Your final state</p>

            <div style="margin: 2rem 0;">
                <div style="font-size: 1rem; color: var(--text-muted); margin-bottom: 0.5rem;">FINAL SCORE</div>
                <div id="final-score" style="font-size: 4rem; font-weight: 700; color: var(--accent-primary);">0</div>
            </div>

            <div class="badge-container" id="final-badges">
                <div class="badge" id="badge-speed" title="Speed (>60 WPM)">‚ö°<span class="badge-tooltip">Flow Master<br><small style="opacity: 0.8; font-size: 0.75em;">60+ WPM</small></span></div>
                <div class="badge" id="badge-acc" title="Accuracy (100%)">üéØ<span class="badge-tooltip">Perfectionist<br><small style="opacity: 0.8; font-size: 0.75em;">98%+ Accuracy</small></span></div>
                <div class="badge" id="badge-endurance" title="Completed All">üõ°Ô∏è<span class="badge-tooltip">Resilient<br><small style="opacity: 0.8; font-size: 0.75em;">Complete All Stages</small></span></div>
                <div class="badge" id="badge-god" title="God Mode (>100 WPM)">‚ú®<span class="badge-tooltip">Transcendent<br><small style="opacity: 0.8; font-size: 0.75em;">100+ WPM</small></span></div>
            </div>

            <div id="name-entry" style="margin-top: 2.5rem; display: none;">
                <p style="color: var(--accent-success); margin-bottom: 1rem; font-size: 0.9rem;">NEW PERSONAL BEST</p>
                <input type="text" id="player-name" placeholder="Enter your name" maxlength="12"
                    style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); padding: 0.8rem 1.5rem; color: white; font-family: var(--font-ui); text-align: center; font-size: 1.1rem; border-radius: 8px; outline: none; width: 200px;">
                <br>
                <button id="btn-submit-score" class="btn" style="margin-top: 1rem; font-size: 0.9rem; padding: 0.8rem 2rem;">Save Record</button>
            </div>

            <div style="margin-top: 2.5rem;">
                <button id="btn-restart" class="btn" style="background: transparent; border: none; color: var(--text-muted); font-size: 0.9rem;">Restart Journey</button>
            </div>
        </div>
    </div>

    <!-- LEADERBOARD MODAL -->
    <div id="leaderboard-modal" class="leaderboard-modal">
        <div class="leaderboard-content">
            <button class="lb-close-btn" id="lb-close-btn">‚úï</button>
            <div class="lb-header">
                <span class="lb-trophy">üèÜ</span>
                <h2>Hall of Champions</h2>
                <p>Ranked by typing speed (WPM)</p>
            </div>
            <div class="lb-list" id="lb-full-list"></div>
        </div>
    </div>

    <!-- RULES MODAL -->
    <div id="rules-modal" class="rules-modal">
        <div class="rules-content">
            <button class="lb-close-btn" id="rules-close-btn">‚úï</button>
            
            <div class="rules-header">
                <span style="font-size: 2.5rem; display: block; margin-bottom: 0.5rem;">üìñ</span>
                <h2>How to Play</h2>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Master the art of typing</p>
            </div>

            <div class="rules-section">
                <h3>üéÆ Game Overview</h3>
                <p>Aura Type is a 3-stage typing challenge. Type the words that appear on screen as fast and accurately as possible. Complete all stages to finish your journey!</p>
            </div>

            <div class="rules-section">
                <h3>üìä The Three Stages</h3>
                <table class="score-table">
                    <tr>
                        <th>Stage</th>
                        <th>Time</th>
                        <th>Words</th>
                        <th>Difficulty</th>
                    </tr>
                    <tr>
                        <td>Flow</td>
                        <td>45s</td>
                        <td>18 words</td>
                        <td>Short words (4-5 letters)</td>
                    </tr>
                    <tr>
                        <td>Precision</td>
                        <td>40s</td>
                        <td>22 words</td>
                        <td>Complex words (7-10 letters)</td>
                    </tr>
                    <tr>
                        <td>Mastery</td>
                        <td>50s</td>
                        <td>12 phrases</td>
                        <td>Full phrases</td>
                    </tr>
                </table>
            </div>

            <div class="rules-section">
                <h3>‚≠ê Scoring System</h3>
                <p>Your score is calculated based on:</p>
                <ul>
                    <li><span class="score-highlight">Word Length √ó 10</span> ‚Äî Longer words = more points</li>
                    <li><span class="score-highlight">Stage Bonus √ó 5</span> ‚Äî Higher stages give bonus multiplier</li>
                    <li><span class="score-highlight">+15 Perfect Bonus</span> ‚Äî No typos in a word</li>
                    <li><span class="score-highlight">-20 Penalty</span> ‚Äî Wrong word costs you points!</li>
                </ul>
                <p style="margin-top: 0.75rem;"><strong style="color: var(--text-main);">Example:</strong> Typing "harmony" perfectly in Precision = <span class="score-highlight">(7 √ó 10) + 10 + 15 = 95 points</span></p>
            </div>

            <div class="rules-section">
                <h3>üèÜ Leaderboard Ranking</h3>
                <p>Rankings are determined by:</p>
                <ul>
                    <li><strong style="color: var(--text-main);">Primary:</strong> WPM (faster typist wins)</li>
                    <li><strong style="color: var(--text-main);">Tiebreaker:</strong> Accuracy (higher accuracy wins)</li>
                </ul>
                <p style="margin-top: 0.5rem; font-size: 0.85rem;">Same WPM? The more accurate typist takes the higher rank!</p>
            </div>

            <div class="rules-section">
                <h3>‚ö° WPM (Words Per Minute)</h3>
                <p>WPM measures your typing speed. It's calculated as:</p>
                <p style="text-align: center; margin: 0.75rem 0;"><span class="score-highlight">WPM = (Characters Typed √∑ 5) √∑ Minutes Elapsed</span></p>
                <p>A "word" is standardized as 5 characters. Higher WPM = faster typing!</p>
            </div>

            <div class="rules-section">
                <h3>üèÖ Badges & Achievements</h3>
                <div class="badge-explain">
                    <span class="badge-icon">‚ö°</span>
                    <div class="badge-info">
                        <div class="badge-name">Flow Master</div>
                        <div class="badge-req">Achieve WPM greater than 60</div>
                    </div>
                </div>
                <div class="badge-explain">
                    <span class="badge-icon">üéØ</span>
                    <div class="badge-info">
                        <div class="badge-name">Perfectionist</div>
                        <div class="badge-req">Maintain 98%+ accuracy</div>
                    </div>
                </div>
                <div class="badge-explain">
                    <span class="badge-icon">üõ°Ô∏è</span>
                    <div class="badge-info">
                        <div class="badge-name">Resilient</div>
                        <div class="badge-req">Complete all 3 stages</div>
                    </div>
                </div>
                <div class="badge-explain">
                    <span class="badge-icon">‚ú®</span>
                    <div class="badge-info">
                        <div class="badge-name">Transcendent</div>
                        <div class="badge-req">Achieve WPM greater than 100 (God Mode!)</div>
                    </div>
                </div>
            </div>

            <div class="rules-section">
                <h3>üí° Tips</h3>
                <ul>
                    <li>Focus on accuracy first, speed will follow</li>
                    <li>Keep your fingers on the home row</li>
                    <li>Don't look at the keyboard</li>
                    <li>Stay relaxed ‚Äî tension slows you down</li>
                    <li>Practice daily for best results</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: atob("QUl6YVN5Qjl6N3ZRczJOWUhvcGFWV2lzQ1NRSVhzN0gySGNrMXpB"),
            authDomain: "baby2-b7a68.firebaseapp.com",
            projectId: "baby2-b7a68",
            storageBucket: "baby2-b7a68.appspot.com",
            messagingSenderId: "568691519195",
            appId: "1:568691519195:web:dabbe2bac687b9065e66fe"
        };

        let app, db, lbRef;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            lbRef = collection(db, "leaderboards");
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // --- UNIQUE PSYCHOLOGICAL WORDS (No repeats across levels) ---
        const WORDS = {
            flow: [
                "calm", "grow", "hope", "mind", "soul", "free", "bold", "wise",
                "grit", "zeal", "pure", "ease", "peak", "rise", "glow", "deep",
                "true", "warm", "safe", "kind", "real", "open", "live", "move",
                "rest", "heal", "lift", "soar", "beam", "core"
            ],
            precision: [
                "breathe", "balance", "clarity", "courage", "embrace", "evolve",
                "flourish", "gratitude", "harmony", "inspire", "journey", "mindful",
                "patience", "persist", "purpose", "reflect", "resilient", "serenity",
                "strength", "thrive", "transform", "triumph", "vibrant", "wellness",
                "wisdom", "wonder", "achieve", "believe", "centered", "devoted",
                "empower", "focused", "genuine", "hopeful", "insight", "joyful"
            ],
            mastery: [
                "progress not perfection",
                "embrace the journey",
                "trust the process",
                "growth takes time",
                "be here now",
                "one step at a time",
                "believe in yourself",
                "stay curious always",
                "learn from failure",
                "create your path",
                "focus on today",
                "small wins matter",
                "keep moving forward",
                "you are enough",
                "breathe and begin",
                "action beats fear",
                "start where you are",
                "patience brings mastery",
                "consistency is key",
                "embrace the challenge"
            ]
        };

        const STAGES = [
            { id: 'flow', name: "Flow State", time: 45, words: 18, diff: 'flow' },
            { id: 'precision', name: "Precision", time: 40, words: 22, diff: 'precision' },
            { id: 'mastery', name: "Mastery", time: 50, words: 12, diff: 'mastery' }
        ];

        // --- STATE ---
        let state = {
            stageIdx: 0,
            score: 0,
            wpm: 0,
            accuracy: 0,
            wordsTyped: 0,
            charsTyped: 0,
            correctChars: 0,
            errors: 0,
            correctWords: 0,
            wrongWords: 0,
            startTime: 0,
            timer: null,
            timeLeft: 0,
            currentWord: "",
            inputVal: "",
            isPlaying: false,
            stageWordsDone: 0,
            usedWords: new Set()
        };

        // --- DOM ---
        const screens = {
            start: document.getElementById('start-screen'),
            game: document.getElementById('game-screen'),
            round: document.getElementById('round-screen'),
            end: document.getElementById('end-screen')
        };

        const els = {
            input: document.getElementById('input-field'),
            target: document.getElementById('target-word'),
            hudRound: document.getElementById('hud-round'),
            hudScore: document.getElementById('hud-score'),
            hudTime: document.getElementById('hud-time'),
            hudWpm: document.getElementById('hud-wpm'),
            progress: document.getElementById('progress-fill'),
            lbFullList: document.getElementById('lb-full-list'),
            lbModal: document.getElementById('leaderboard-modal'),
            nameEntry: document.getElementById('name-entry'),
            finalScore: document.getElementById('final-score'),
            btnStart: document.getElementById('btn-start'),
            roundName: document.getElementById('round-name-display')
        };

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume().catch(e => { });
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'type') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.05);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);
            } else if (type === 'error') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
                osc.start(now);
                osc.stop(now + 0.15);
            } else if (type === 'success') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }

        // --- 3D BACKGROUND ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        const particlesGeometry = new THREE.BufferGeometry();
        const particlesCount = 700;
        const posArray = new Float32Array(particlesCount * 3);
        for (let i = 0; i < particlesCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 20;
        }
        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const particlesMaterial = new THREE.PointsMaterial({ size: 0.03, color: 0x818cf8, transparent: true, opacity: 0.6, blending: THREE.AdditiveBlending });
        const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
        scene.add(particlesMesh);
        camera.position.z = 5;

        let mouseX = 0, mouseY = 0;
        document.addEventListener('mousemove', (event) => {
            mouseX = event.clientX / window.innerWidth - 0.5;
            mouseY = event.clientY / window.innerHeight - 0.5;
        });

        function animate3D() {
            requestAnimationFrame(animate3D);
            particlesMesh.rotation.y += 0.001;
            particlesMesh.rotation.x += 0.0005;
            camera.position.x += (mouseX * 0.5 - camera.position.x) * 0.05;
            camera.position.y += (-mouseY * 0.5 - camera.position.y) * 0.05;
            renderer.render(scene, camera);
        }
        animate3D();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- LEADERBOARD FUNCTIONS ---
        function openLeaderboard() {
            els.lbModal.classList.add('active');
            gsap.fromTo(els.lbModal.querySelector('.leaderboard-content'), 
                { opacity: 0, scale: 0.9, y: 30 },
                { opacity: 1, scale: 1, y: 0, duration: 0.4, ease: "back.out(1.7)" }
            );
        }

        function closeLeaderboard() {
            gsap.to(els.lbModal.querySelector('.leaderboard-content'), {
                opacity: 0, scale: 0.9, y: 30, duration: 0.3, ease: "power2.in",
                onComplete: () => els.lbModal.classList.remove('active')
            });
        }

        function renderLeaderboardEntry(player, index) {
            const topClass = index === 0 ? 'top-1' : index === 1 ? 'top-2' : index === 2 ? 'top-3' : '';
            const accuracy = player.accuracy || 0;
            const wpm = player.wpm || 0;
            
            // Choose icon based on accuracy
            let accuracyIcon = 'üéØ';
            if (accuracy >= 98) accuracyIcon = 'üíé';
            else if (accuracy >= 95) accuracyIcon = '‚≠ê';
            else if (accuracy >= 90) accuracyIcon = 'üéØ';
            else if (accuracy >= 80) accuracyIcon = '‚úì';
            
            return `
                <div class="lb-entry ${topClass}">
                    <div class="lb-rank">${index + 1}</div>
                    <div class="lb-player-info">
                        <div class="lb-player-name">${player.name}</div>
                        <div class="lb-player-stats">
                            <div class="lb-accuracy-badge">
                                <span class="lb-accuracy-icon">${accuracyIcon}</span>
                                <span>Accuracy: </span>
                                <span class="lb-accuracy-value">${accuracy}%</span>
                            </div>
                        </div>
                    </div>
                    <div class="lb-wpm-display">
                        <div class="lb-wpm-number">${wpm}</div>
                        <div class="lb-wpm-label">WPM</div>
                    </div>
                </div>
            `;
        }

        // --- GAME LOGIC ---
        function switchScreen(name) {
            Object.values(screens).forEach(s => {
                if (s.classList.contains('active')) {
                    s.classList.remove('active');
                    s.style.display = 'none';
                }
            });
            const target = screens[name];
            target.style.display = 'flex';
            void target.offsetWidth;
            target.classList.add('active');
            gsap.fromTo(target, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.5, ease: "power3.out" });
        }

        function startGame() {
            els.btnStart.disabled = true;
            state.score = 0;
            state.stageIdx = 0;
            state.wpm = 0;
            state.wordsTyped = 0;
            state.charsTyped = 0;
            state.correctChars = 0;
            state.errors = 0;
            state.correctWords = 0;
            state.wrongWords = 0;
            state.startTime = Date.now();
            state.usedWords = new Set();
            startStage();
        }

        function startStage() {
            const stage = STAGES[state.stageIdx];
            if (!stage) { endGame(); return; }

            state.timeLeft = stage.time;
            state.stageWordsDone = 0;
            state.isPlaying = true;

            els.hudRound.innerText = stage.name;
            els.hudScore.innerText = state.score;
            els.progress.style.width = '0%';

            // Hide nav and lock scroll during gameplay
            document.getElementById('mini-nav').classList.add('hidden');
            document.body.classList.add('game-active');
            window.scrollTo(0, 0);

            switchScreen('game');
            nextWord();

            if (state.timer) clearInterval(state.timer);
            state.timer = setInterval(gameLoop, 1000);

            setTimeout(() => { els.input.value = ''; els.input.focus(); }, 100);
            document.addEventListener('click', keepFocus);
        }

        function keepFocus() { if (state.isPlaying) els.input.focus(); }

        // Prevent scroll during gameplay on mobile
        function preventScroll(e) {
            if (state.isPlaying) {
                e.preventDefault();
            }
        }
        document.addEventListener('touchmove', preventScroll, { passive: false });

        function nextWord() {
            const stage = STAGES[state.stageIdx];
            const list = WORDS[stage.diff];
            let availableWords = list.filter(w => !state.usedWords.has(w));
            if (availableWords.length === 0) {
                state.usedWords.clear();
                availableWords = list;
            }
            state.currentWord = availableWords[Math.floor(Math.random() * availableWords.length)];
            state.usedWords.add(state.currentWord);
            state.inputVal = "";
            els.input.value = "";
            renderWord();
        }

        function renderWord() {
            const word = state.currentWord;
            const input = state.inputVal;
            let html = '';
            for (let i = 0; i < word.length; i++) {
                if (i < input.length) {
                    const isCorrect = input[i] === word[i];
                    html += `<span class="${isCorrect ? 'char-correct' : 'char-wrong'}">${word[i]}</span>`;
                } else {
                    html += `<span class="char-pending">${word[i]}</span>`;
                }
            }
            els.target.innerHTML = html;
        }

        els.input.addEventListener('input', (e) => {
            if (!state.isPlaying) return;
            const val = e.target.value.toLowerCase();
            const word = state.currentWord;

            if (val.length > state.inputVal.length) {
                const charIdx = val.length - 1;
                state.charsTyped++;
                if (val[charIdx] === word[charIdx]) {
                    playSound('type');
                    state.correctChars++;
                } else {
                    playSound('error');
                    state.errors++;
                    gsap.to(els.target, { x: 5, duration: 0.05, yoyo: true, repeat: 3 });
                }
            }

            state.inputVal = val;
            renderWord();

            if (val.length >= word.length) {
                const isCorrect = val === word;
                if (isCorrect) {
                    playSound('success');
                    // Base score: word length √ó 10 + stage bonus
                    let baseScore = (word.length * 10) + ((state.stageIdx + 1) * 5);
                    // Accuracy bonus: extra points for no errors in this word
                    const wordErrors = val.split('').filter((c, i) => c !== word[i]).length;
                    if (wordErrors === 0) {
                        baseScore += 15; // Perfect word bonus
                    }
                    state.score += baseScore;
                    state.correctWords++;
                } else {
                    playSound('error');
                    // Penalty for wrong word: lose points
                    state.score = Math.max(0, state.score - 20);
                    state.wrongWords++;
                    gsap.to(els.target, { color: 'var(--accent-error)', duration: 0.2, onComplete: () => { els.target.style.color = ''; } });
                }

                state.wordsTyped++;
                state.stageWordsDone++;
                els.hudScore.innerText = state.score;
                const progress = (state.stageWordsDone / STAGES[state.stageIdx].words) * 100;
                els.progress.style.width = `${progress}%`;
                els.input.value = '';
                state.inputVal = '';

                if (state.stageWordsDone >= STAGES[state.stageIdx].words) {
                    endStage();
                } else {
                    nextWord();
                }
            }
        });

        function gameLoop() {
            state.timeLeft--;
            els.hudTime.innerText = state.timeLeft;
            // Calculate WPM based on correct characters only (more accurate)
            const elapsedMin = (Date.now() - state.startTime) / 60000;
            state.wpm = Math.round((state.correctChars / 5) / elapsedMin) || 0;
            els.hudWpm.innerText = state.wpm;
            if (state.timeLeft <= 0) endStage();
        }

        function endStage() {
            clearInterval(state.timer);
            state.isPlaying = false;
            document.removeEventListener('click', keepFocus);

            // Show nav and unlock scroll when not playing
            document.getElementById('mini-nav').classList.remove('hidden');
            document.body.classList.remove('game-active');

            if (state.stageIdx < STAGES.length - 1) {
                const acc = state.charsTyped > 0 ? Math.max(0, Math.round((state.correctChars / state.charsTyped) * 100)) : 100;
                document.getElementById('round-acc').innerText = acc + '%';
                document.getElementById('round-words').innerText = state.wordsTyped;
                els.roundName.innerText = STAGES[state.stageIdx].name + " Complete";
                switchScreen('round');
            } else {
                endGame();
            }
        }

        function endGame() {
            switchScreen('end');
            els.finalScore.innerText = state.score;
            els.btnStart.disabled = false;

            // Calculate final accuracy based on correct chars vs total chars typed
            const acc = state.charsTyped > 0 ? Math.max(0, Math.round((state.correctChars / state.charsTyped) * 100)) : 0;
            state.accuracy = acc; // Store for saving to database
            
            document.getElementById('badge-speed').classList.toggle('unlocked', state.wpm > 60);
            document.getElementById('badge-acc').classList.toggle('unlocked', acc >= 98);
            document.getElementById('badge-endurance').classList.toggle('unlocked', true);
            document.getElementById('badge-god').classList.toggle('unlocked', state.wpm > 100);

            if (window.confetti) {
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 }, colors: ['#818cf8', '#c084fc', '#ffffff'] });
            }
            checkLeaderboard(state.wpm);
        }

        async function checkLeaderboard(wpm) {
            if (!lbRef) return;
            try {
                const q = query(lbRef, orderBy("wpm", "desc"), limit(50));
                const snap = await getDocs(q);
                let data = snap.docs.map(d => d.data());
                // Sort by WPM, then accuracy as tiebreaker
                data.sort((a, b) => {
                    if ((b.wpm || 0) !== (a.wpm || 0)) return (b.wpm || 0) - (a.wpm || 0);
                    return (b.accuracy || 0) - (a.accuracy || 0);
                });
                data = data.slice(0, 25);
                const lowestWpm = data.length < 25 ? 0 : data[data.length - 1].wpm;
                if (wpm > lowestWpm || data.length < 25) {
                    els.nameEntry.style.display = 'block';
                    setTimeout(() => els.nameEntry.scrollIntoView({ behavior: 'smooth' }), 500);
                } else {
                    els.nameEntry.style.display = 'none';
                }
            } catch (e) { console.error(e); }
        }

        // --- RULES MODAL ---
        const rulesModal = document.getElementById('rules-modal');
        
        function openRules() {
            rulesModal.classList.add('active');
            gsap.fromTo(rulesModal.querySelector('.rules-content'), 
                { opacity: 0, scale: 0.9, y: 30 },
                { opacity: 1, scale: 1, y: 0, duration: 0.4, ease: "back.out(1.7)" }
            );
        }

        function closeRules() {
            gsap.to(rulesModal.querySelector('.rules-content'), {
                opacity: 0, scale: 0.9, y: 30, duration: 0.3, ease: "power2.in",
                onComplete: () => rulesModal.classList.remove('active')
            });
        }

        // --- EVENT LISTENERS ---
        els.btnStart.addEventListener('click', startGame);

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && screens.start.classList.contains('active') && !els.btnStart.disabled) {
                startGame();
            }
            if (e.code === 'Escape') {
                if (els.lbModal.classList.contains('active')) closeLeaderboard();
                if (rulesModal.classList.contains('active')) closeRules();
            }
        });

        document.getElementById('btn-view-leaderboard').addEventListener('click', openLeaderboard);
        document.getElementById('lb-close-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            closeLeaderboard();
        });
        els.lbModal.addEventListener('click', (e) => { if (e.target === els.lbModal) closeLeaderboard(); });

        document.getElementById('btn-how-to-play').addEventListener('click', openRules);
        document.getElementById('rules-close-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            closeRules();
        });
        rulesModal.addEventListener('click', (e) => { if (e.target === rulesModal) closeRules(); });

        document.getElementById('btn-next-round').addEventListener('click', () => { state.stageIdx++; startStage(); });
        document.getElementById('btn-restart').addEventListener('click', () => { switchScreen('start'); els.btnStart.disabled = false; });

        document.getElementById('btn-submit-score').addEventListener('click', async () => {
            let name = document.getElementById('player-name').value.trim() || 'Anonymous';
            const btn = document.getElementById('btn-submit-score');
            btn.disabled = true;
            btn.innerText = "Saving...";
            
            // Calculate final accuracy before saving
            const finalAccuracy = state.charsTyped > 0 ? Math.max(0, Math.round((state.correctChars / state.charsTyped) * 100)) : 0;
            
            try {
                // Check if this name already exists
                const existingQuery = query(lbRef, orderBy("name"));
                const existingSnap = await getDocs(existingQuery);
                const existingPlayers = existingSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Find exact match for this name
                const exactMatch = existingPlayers.find(p => p.name === name);
                
                if (exactMatch) {
                    // Same player - check if new score is better
                    if (state.wpm > (exactMatch.wpm || 0)) {
                        // Update existing record with better score
                        const docToUpdate = doc(db, "leaderboards", exactMatch.id);
                        await updateDoc(docToUpdate, {
                            score: state.score,
                            wpm: state.wpm,
                            accuracy: finalAccuracy,
                            timestamp: new Date()
                        });
                        showToast("üéâ New Personal Best!");
                    } else {
                        // Worse score - don't save
                        showToast("Previous score was better!");
                    }
                } else {
                    // New player - but check if similar names exist (Vansh, Vansh2, etc.)
                    const baseName = name.replace(/\d+$/, ''); // Remove trailing numbers
                    const similarNames = existingPlayers.filter(p => p.name.startsWith(baseName));
                    
                    if (similarNames.length > 0 && similarNames[0].name === baseName) {
                        // Similar name exists - ask user if they're the same person
                        const isSamePerson = confirm(`A player named "${baseName}" already exists. Are you the same person?\n\nClick OK if YES (we'll update your score)\nClick CANCEL if NO (we'll add a number to your name)`);
                        
                        if (isSamePerson) {
                            // Update existing player's score if better
                            const existingPlayer = similarNames[0];
                            if (state.wpm > (existingPlayer.wpm || 0)) {
                                const docToUpdate = doc(db, "leaderboards", existingPlayer.id);
                                await updateDoc(docToUpdate, {
                                    score: state.score,
                                    wpm: state.wpm,
                                    accuracy: finalAccuracy,
                                    timestamp: new Date()
                                });
                                showToast("üéâ Score Updated!");
                            } else {
                                showToast("Previous score was better!");
                            }
                        } else {
                            // Different person - add number suffix
                            let counter = 2;
                            let newName = `${baseName}${counter}`;
                            while (existingPlayers.some(p => p.name === newName)) {
                                counter++;
                                newName = `${baseName}${counter}`;
                            }
                            name = newName;
                            
                            // Save with new numbered name
                            await addDoc(lbRef, {
                                name: name,
                                score: state.score,
                                wpm: state.wpm,
                                accuracy: finalAccuracy,
                                timestamp: new Date()
                            });
                            showToast(`Saved as "${name}"!`);
                        }
                    } else {
                        // Completely new name - save it
                        await addDoc(lbRef, {
                            name: name,
                            score: state.score,
                            wpm: state.wpm,
                            accuracy: finalAccuracy,
                            timestamp: new Date()
                        });
                        showToast("Score Saved to Cloud!");
                    }
                }
                
                els.nameEntry.style.display = 'none';
            } catch (e) { 
                console.error(e); 
                showToast("Error Saving Score"); 
            }
            btn.disabled = false;
            btn.innerText = "Save Record";
        });

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // --- LEADERBOARD LIVE FEED ---
        if (lbRef) {
            onSnapshot(query(lbRef, orderBy("wpm", "desc"), limit(50)), (snap) => {
                let players = snap.docs.map(d => d.data());
                
                // Sort by WPM first, then by accuracy as tiebreaker
                players.sort((a, b) => {
                    if ((b.wpm || 0) !== (a.wpm || 0)) return (b.wpm || 0) - (a.wpm || 0);
                    return (b.accuracy || 0) - (a.accuracy || 0);
                });
                
                // Take top 25 after sorting
                players = players.slice(0, 25);
                
                // Render leaderboard
                if (players.length === 0) {
                    els.lbFullList.innerHTML = `
                        <div class="lb-empty">
                            <div class="lb-empty-icon">üéÆ</div>
                            <p>No champions yet!</p>
                            <p style="font-size: 0.85rem; margin-top: 0.5rem;">Be the first to claim the throne</p>
                        </div>
                    `;
                } else {
                    els.lbFullList.innerHTML = players.map((p, i) => renderLeaderboardEntry(p, i)).join('');
                }
            });
        }

        // Init
        switchScreen('start');
    </script>
</body>
</html>